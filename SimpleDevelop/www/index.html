<!DOCTYPE html>
<html>
  <head>
    <title>SimpleDevelop</title>
    <link rel="stylesheet" type="text/css" href="/css/codemirror.css" />
    <link rel="stylesheet" type="text/css" href="/css/show-hint.css" />
    <link rel="stylesheet" type="text/css" href="/css/theme/solarized.css" />
    <script type="text/javascript" src="/js/codemirror-3.1.js"></script>
    <script type="text/javascript" src="/js/show-hint.js"></script>
    <script type="text/javascript" src="/js/mode/clike.js"></script>
    <script type="text/javascript" src="/js/jquery-1.9.1.min.js"></script>

    <style type="text/css">
      html, body {
        height: 100%;
        width: 100%;
        margin: 0;
        padding: 0;
      }

      .CodeMirror {
        position: absolute;
        top: 0;
        bottom: 0;
        height: 100%;
        width: 100%;

        font-family: "Source Code Pro", Consolas, Inconsolata, monospace;
        font-size: 16px;
      }

      .CodeMirror-scroll {
        overflow: auto;
      }

      .editing .CodeMirror {
        left: 0;
        right: 0;
      }

      .results {
        position: absolute;
        display: none;
        top: 0;
        bottom: 0;
        right: 0;
        width: 0;

        background-color: #000;
        color: #fff;
        font-family: "Source Code Pro", Consolas, Inconsolata, monospace;
        font-size: 14px;
        overflow: auto;
        z-index: 10;
      }

      .viewing-results .CodeMirror {
        left: 0;
        right: 50%;
      }

      .viewing-results .results {
        display: block;
        left: 50%;
        width: auto;
        padding: 25px;
      }

      .dialog {
        position: absolute;
        top: 25%;
        bottom: 25%;
        left: 25%;
        right: 25%;
        background-color: #000;
        color: #fff;
        opacity: 0.75;
        overflow: auto;
        z-index: 10;
      }

      /* Why do the embedded web browsers suck? */
      .dialog.empty {
        display: none;
      }

      .toolbar {
        position: absolute;
        bottom: 20px;
        left: 20px;
        right: 20px;
        height: 60px;
        opacity: 0.5;
        filter: alpha(opacity = 50);
        z-index: 10;
      }

      .editing .toolbar {
        background: #000;
      }

      .viewing-results .toolbar {
        background-color: #444;
      }

      .toolbar a {
        display: inline-block;
        float: right;
        line-height: 60px;
        color: #fff;
        font-family: "Open Sans", Helvetica, Arial, sans-serif;
        font-size: 16px;
        padding: 0 1em;
        text-decoration: none;
      }

      .toolbar a:hover {
        background-color: #fff;
        color: #888;
      }

      /* Open file dialog */
      ul.file-list {
        list-style: none;
        padding-left: 0;
        width: 100%;
      }

      ul.file-list li {
        height: 30px;
        font-family: "Open Sans", Helvetica, Arial, sans-serif;
        font-size: 14px;
        padding: 0 1em;
      }

      ul.file-list li a {
        color: #fff;
        line-height: 30px;
      }

      ul.file-list li:hover {
        background-color: #fff;
      }

      ul.file-list li:hover a {
        color: #888;
      }
    </style>

    <script type="text/javascript">
      $(document).ready(function() {
        var $body    = $("body"),
            $results = $(".results"),
            $dialog  = $(".dialog"),
            editor   = CodeMirror.fromTextArea(document.getElementById("editor"), {
              lineNumbers: true,
              mode: "text/x-csharp",
              theme: "solarized dark"
            }),
            changesToParse = false;

        function populateDialog(html) {
          $dialog.removeClass("empty").html(html);
        }

        function clearDialog() {
          $dialog.addClass("empty").empty();
        }

        function displayError(error) {
          $dialog.removeClass("empty").html("<pre>" + error + "</pre>");
        }

        function sendRequest(route, data, options) {
          options = options || {};

          $.ajax($.extend({
            url: route,
            type: "POST",
            dataType: "json",
            data: data,
            success: function(data) {
              if (data.Error) {
                displayError(data.Error);
              } else if (options.callback) {
                options.callback(data);
              }
            },
            error: function() {
              displayError("An unexpected error occurred.");
            }
          }, options));
        }

        $(".open").click(function() {
          var directory = prompt("Enter a directory.");
          sendRequest("/open", { directory: directory }, {
            dataType: "html",
            callback: function(html) {
              populateDialog(html);
            }
          });
        });

        $(".compile").click(function() {
          sendRequest("/compile", { code: editor.getValue() }, {
            callback: function(results) {
              $body.attr("class", "viewing-results");
              $results.html("<pre>" + results + "</pre>");
            }
          });
        });

        $(".exit").click(function() {
          sendRequest("/exit", {}, {
            callback: window.close
          });
        });

        $results.click(function() {
          $body.attr("class", "editing");
          $results.empty();
        });

        $dialog.click(function() {
          clearDialog();
        });

        $dialog.on("click", ".file a", function() {
          var filepath = $(this).attr("href");
          sendRequest("/open", { filepath: filepath }, {
            type: "GET",
            callback: function(text) {
              editor.setValue(text);
              clearDialog();
            }
          });
          return false;
        });

        editor.on("change", function() {
          changesToParse = true;
        });

        // This shouldn't be necessary.
        clearDialog();

        // Just periodically throw everything over the wall. Let's see how this goes.
        setInterval(function() {
          if (changesToParse) {
            sendRequest("/parse", { code: editor.getValue() });
            changesToParse = false;
          }
        }, 2000);

        editor.addKeyMap({
          ".": function(e) {
            var cursor = e.getCursor();
            var token  = e.getTokenAt({ line: cursor.line, ch: cursor.ch - 1 });
            var json   = JSON.stringify({ token: token.string, line: cursor.line, col: cursor.ch });
            sendRequest("/complete", { data: json }, {
              callback: function(items) {
                CodeMirror.showHint(editor, function(e) {
                  return {
                    list: $.map(items, function() { return this.Text }),
                    from: token.end,
                    to: token.end
                  };
                });
              }
            });
          }
        });

        // Just for debugging, for me.
        window.CMEditor = editor;
      });
    </script>
  </head>

  <body class="editing">
    <textarea id="editor">{{ExampleCode}}</textarea>
    <div class="results"></div>
    <div class="dialog" class="empty"></div>
    <div class="toolbar">
      <a class="exit" href="#">Exit</a>
      <a class="compile" href="#">Compile</a>
      <a class="open" href="#">Open</a>
    </div>
  </body>

</html>
